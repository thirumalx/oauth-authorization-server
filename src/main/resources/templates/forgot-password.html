<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Reset your password">
    <title>Forgot Password - Authorization Server</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link th:href="@{/style/signup.css}" rel="stylesheet" />
</head>

<body>

    <div class="content">

        <h2 class="title">Forgot Password?</h2>

        <!-- Info message - changes based on form state -->
        <p th:if="${!showOtpForm}"
            style="text-align:center; margin-top:-10px; margin-bottom:30px; color:#6b7280; font-size:14px;">
            Enter your email or phone number and new password. We'll send you a verification code.
        </p>

        <p th:if="${showOtpForm}"
            style="text-align:center; margin-top:-10px; margin-bottom:10px; color:#374151; font-weight:500;">
            Verification code sent to: <span th:text="${resetPassword.loginId}">user@example.com</span>
        </p>
        <p th:if="${showOtpForm}" style="text-align:center; margin-bottom:30px; color:#6b7280; font-size:14px;">
            Enter the code below to reset your password.
        </p>

        <!-- Success Message -->
        <div th:if="${success}" class="success-message"
            style="background: #d1fae5; padding: 12px 16px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #10b981;">
            <p style="margin:0; color:#065f46; font-size:14px;" th:text="${success}"></p>
        </div>

        <!-- Error Messages -->
        <div th:if="${error}" class="error-message"
            style="background: #fee2e2; padding: 12px 16px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #dc2626;">
            <p style="margin:0; color:#dc2626; font-size:14px;" th:text="${error}"></p>
        </div>

        <!-- Initial Form - Request OTP -->
        <form th:if="${!showOtpForm}" th:action="@{/forgot-password/request-otp}" method="post" id="requestOtpForm">

            <!-- Login ID Input -->
            <div class="form-row">
                <div class="form-field">
                    <label>Email or Phone Number</label>
                    <input type="text" name="loginId" th:value="${resetPassword.loginId}" required autofocus
                        placeholder="Enter your email or phone number" autocomplete="username">
                </div>
            </div>

            <!-- New Password Input -->
            <div class="form-row">
                <div class="form-field">
                    <label>New Password</label>
                    <input type="password" name="password" required minlength="8" placeholder="Enter new password"
                        autocomplete="new-password">
                    <small style="display:block; color:#6b7280; margin-top:4px; font-size:12px;">
                        Must contain at least 8 characters, 1 uppercase, 1 lowercase, 1 digit, and 1 special character
                    </small>
                </div>
            </div>

            <!-- Confirm Password Input -->
            <div class="form-row">
                <div class="form-field">
                    <label>Confirm New Password</label>
                    <input type="password" name="confirmPassword" required minlength="8"
                        placeholder="Confirm new password" autocomplete="new-password">
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="primary-btn" id="requestOtpBtn">Send Verification Code</button>

            <!-- Back to login link -->
            <p style="text-align:center; margin-top:20px; font-size:14px; color:#6b7280;">
                Remember your password?
                <a th:href="@{/login}" style="color:#667eea; font-weight:600; text-decoration:none;">
                    Back to login
                </a>
            </p>

        </form>

        <!-- OTP Form - Verify and Reset -->
        <form th:if="${showOtpForm}" th:action="@{/forgot-password/reset}" th:object="${resetPassword}" method="post"
            id="resetPasswordForm">

            <!-- Hidden fields -->
            <input type="hidden" th:field="*{loginId}">
            <input type="hidden" th:field="*{password}">

            <!-- OTP Input -->
            <div class="form-row">
                <div class="form-field">
                    <label>Verification Code</label>
                    <input type="text" th:field="*{otp}" required minlength="6" maxlength="6" pattern="^[0-9]{6}$"
                        placeholder="Enter 6-digit code" autocomplete="off" autofocus>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="primary-btn" id="resetBtn">Reset Password</button>

            <!-- Resend OTP -->
            <div style="text-align:center; margin-top:20px;">
                <form th:action="@{/forgot-password/resend-otp}" method="post" style="display:inline;">
                    <input type="hidden" name="loginId" th:value="${resetPassword.loginId}">
                    <input type="hidden" name="password" th:value="${resetPassword.password}">
                    <button type="submit"
                        style="background:none; border:none; color:#667eea; font-weight:600; cursor:pointer; font-size:14px; text-decoration:underline;">
                        Resend Code
                    </button>
                </form>
                <span style="color:#6b7280; font-size:14px;"> or </span>
                <a th:href="@{/forgot-password}"
                    style="color:#667eea; font-weight:600; text-decoration:none; font-size:14px;">
                    Start over
                </a>
            </div>

        </form>
    </div>

    <script>
        // Password confirmation validation for initial form
        const requestForm = document.getElementById('requestOtpForm');
        if (requestForm) {
            requestForm.addEventListener('submit', function (e) {
                const password = document.querySelector('input[name="password"]');
                const confirmPassword = document.querySelector('input[name="confirmPassword"]');

                if (password.value !== confirmPassword.value) {
                    e.preventDefault();
                    alert('Passwords do not match. Please try again.');
                    confirmPassword.focus();
                    return false;
                }
            });
        }

        // Auto-focus on appropriate field
        document.addEventListener('DOMContentLoaded', function () {
            const firstInput = document.querySelector('input[autofocus]');
            if (firstInput) {
                firstInput.focus();
            }
        });
    </script>

</body>

</html>